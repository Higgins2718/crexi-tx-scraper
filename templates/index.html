<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Listings</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8fafc; padding: 2rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 2rem; color: #1e293b; font-weight: 600; font-size: 2rem; }
        .properties { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2rem; }
        .property-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .property-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .property-image { width: 100%; height: 200px; object-fit: cover; }
        .property-content { padding: 1.5rem; }
        .property-name { font-size: 1.2rem; font-weight: 600; color: #1e293b; margin-bottom: 0.5rem; }
        .property-description { color: #64748b; margin-bottom: 1rem; }
        .property-details { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .property-type { background: #3b82f6; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; }
        .property-sqft { font-weight: 600; color: #1e293b; }
        .property-location { color: #64748b; font-size: 0.875rem; margin-bottom: 1rem; }
        .property-footer { display: flex; justify-content: space-between; align-items: center; }
        .broker-info { display: flex; align-items: center; gap: 0.5rem; }
        .broker-logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .broker-name { font-size: 0.875rem; color: #64748b; }
        .new-badge { background: #10b981; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .analytics-section { margin-top: 4rem; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .chart-container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .chart-title { font-size: 1.25rem; font-weight: 600; color: #1e293b; margin-bottom: 1rem; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Latest Property Listings</h1>
        <div class="properties">
            {% for row in data %}
            <div class="property-card">
                <img src="{{ row[3] }}" alt="{{ row[1] }}" class="property-image" loading="lazy" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='">
                <div class="property-content">
                    <h3 class="property-name">{{ row[1] }}</h3>
                    <p class="property-description">{{ row[2] }}</p>
                    <div class="property-details">
                        <span class="property-type">{{ row[16][0] if row[16] and row[16]|length > 0 else 'Property' }}</span>
                        <span class="property-sqft">{{ '{:,}'.format(row[10]) if row[10] else 'N/A' }} sq ft</span>
                    </div>
                    <div class="property-price" style="font-size: 1.5rem; font-weight: 700; color: #059669; margin-bottom: 0.5rem;">
                        {% if row[24] and row[24] != None %}
                            {% if row[24] is number %}
                                ${{ '{:,}'.format(row[24]|int) }}
                            {% else %}
                                ${{ row[24] }}
                            {% endif %}
                        {% else %}
                            Price TBD
                        {% endif %}
                    </div>
                    <p class="property-location">{{ row[21][0]['fullAddress'] if row[21] and row[21]|length > 0 else 'Location TBD' }}</p>
                    <div class="property-activated" style="font-size: 0.75rem; color: #64748b; margin-bottom: 1rem;">
                        Listed: {{ row[6].strftime('%b %d, %Y at %I:%M %p') if row[6] else 'Date TBD' }}
                    </div>
                    <div class="property-footer">
                        <div class="broker-info">
                            <img src="{{ row[23] }}" alt="{{ row[5] }}" class="broker-logo" onerror="this.style.display='none'">
                            <span class="broker-name">{{ row[5] }}</span>
                        </div>
                        {% if row[22] %}
                        <span class="new-badge">NEW</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="blog-section" style="margin-top: 4rem;">
            <div style="background: white; padding: 3rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto;">
                <h2 style="text-align: center; color: #1e293b; font-weight: 600; font-size: 1.75rem; margin-bottom: 1rem; border-bottom: 2px solid #3b82f6; padding-bottom: 1rem;">Market Analysis</h2>
                <div style="text-align: center; color: #64748b; font-size: 0.875rem; margin-bottom: 2rem;">
                    Updated: {{ gpt_analysis[0][1].strftime('%B %d, %Y at %I:%M %p') if gpt_analysis and gpt_analysis|length > 0 else 'Date TBD' }}
                </div>
                <div style="line-height: 1.7; color: #374151; font-size: 1rem;">
                    {% if gpt_analysis and gpt_analysis|length > 0 %}
                        {% for paragraph in gpt_analysis[0][0].split('\n\n') %}
                            {% if paragraph.strip() %}
                                <p style="margin-bottom: 1.5rem;">{{ paragraph.strip() }}</p>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p>No analysis available at this time.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="analytics-section">
            <h2 style="text-align: center; color: #1e293b; font-weight: 600; font-size: 1.75rem;">Market Analytics</h2>
            <div class="analytics-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Price per Sq Ft by City</h3>
                    <canvas id="pricePerSqftChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Average Square Footage</h3>
                    <canvas id="sqftChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Top Cities</h3>
                    <canvas id="cityChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">New Listings Timeline</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Price per Sq Ft Chart
        const pricePerSqftData = {{ analytics.price_per_sqft | tojson }};
        new Chart(document.getElementById('pricePerSqftChart'), {
            type: 'bar',
            data: {
                labels: pricePerSqftData.map(item => item[0]),
                datasets: [{
                    label: '$/Sq Ft',
                    data: pricePerSqftData.map(item => Math.round(item[1])),
                    backgroundColor: pricePerSqftData.map(item => {
                        const price = item[1];
                        if (price < 50) return '#10b981';  // Green for bargains
                        else if (price < 100) return '#3b82f6';  // Blue for mid-range
                        else return '#ef4444';  // Red for premium
                    })
                }]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const price = Math.round(context.parsed.y);
                                const city = context.label;
                                const count = pricePerSqftData[context.dataIndex][2];
                                return [`$${price}/sq ft`, `${count} properties`];
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Price per Sq Ft'
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                }
            }
        });

        // Average Square Footage Chart
        const sqftData = {{ analytics.avg_sqft | tojson }};
        new Chart(document.getElementById('sqftChart'), {
            type: 'bar',
            data: {
                labels: sqftData.map(item => item[0]),
                datasets: [{
                    label: 'Avg Sq Ft',
                    data: sqftData.map(item => Math.round(item[1])),
                    backgroundColor: '#3b82f6'
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });

        // Cities Chart
        const cityData = {{ analytics.cities | tojson }};
        new Chart(document.getElementById('cityChart'), {
            type: 'bar',
            data: {
                labels: cityData.map(item => item[0]),
                datasets: [{
                    label: 'Properties',
                    data: cityData.map(item => item[1]),
                    backgroundColor: '#10b981'
                }]
            },
            options: { 
                responsive: true, 
                plugins: { legend: { display: false } },
                indexAxis: 'y'
            }
        });

        // Timeline Chart
        const timelineData = {{ analytics.timeline | tojson }};
        new Chart(document.getElementById('timelineChart'), {
            type: 'line',
            data: {
                labels: timelineData.map(item => {
                    const date = new Date(item[0]);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'New Listings',
                    data: timelineData.map(item => item[1]),
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: true
                }]
            },
            options: { 
                responsive: true, 
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const date = new Date(timelineData[context[0].dataIndex][0]);
                                return date.toLocaleDateString('en-US', { 
                                    weekday: 'long',
                                    month: 'short', 
                                    day: 'numeric' 
                                });
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'New Listings'
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>